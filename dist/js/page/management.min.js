var DfttModule=function(e){var a={name:"Index",typed:null,word:"",page:1,pageMax:1,init:function(){var e=this;e.tpl=$("#channelTmp").html(),e.writeAppkey(),e.writeAppName(),e.drawAppicon(),e.getAppInfo(),e.handlebarHelp(),e.renderList(),e.removeChannel(),e.selectPage(),e.viewCodeMa(),e.initTime(),e.triggerEvent()},timetrans:function(e){return e=new Date(1e3*e),e.getFullYear()+"-"+(e.getMonth()+1<10?"0"+(e.getMonth()+1):e.getMonth()+1)+"-"+(e.getDate()<10?"0"+e.getDate():e.getDate())+" "+(e.getHours()<10?"0"+e.getHours():e.getHours())+":"+(e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes())+":"+(e.getSeconds()<10?"0"+e.getSeconds():e.getSeconds())},writeAppkey:function(){var e=$.cookie("appkey");e&&($("#app_key").text(e),$("#configAppKey").text(e))},drawAppicon:function(){var e=$.cookie("img");e&&$("#app_icon").attr("src",e)},writeAppName:function(){var e=$.cookie("appName");e&&$("#app_name").text(e)},getAppInfo:function(){var e=this;$.ajax({url:"http://api.shareinstall.com/appliance/getone",data:{app_key:$.cookie("appkey")},type:"POST",success:function(a){var t=a.data.app_over_time.replace(/-/g,"/"),n=parseInt(new Date(t)-new Date)/1e3/60/60/24;a.code=parseInt(a.code),0===a.code&&(0==a.data.status?e.pageInit():n<=10&&2==a.data.status&&e.pageInit(n))}})},pageInit:function(e){var a=$("#paymentInfo"),t=0;e&&(a.find(".pop-status").text("还有"+Math.round(e)+"天服务将过期"),t=1),t&&!$.cookie("warnshow"+$.cookie("appkey"))?($.cookie("warnshow"+$.cookie("appkey"),1,{expires:1}),layer.open({title:"到期提醒",type:1,area:"800",content:a,closeBtn:t})):t||layer.open({title:"到期提醒",type:1,area:"800",content:a,closeBtn:t})},generateCodeMa:function(e,a){var t=$("#_qr_container");t.length<=0&&(t=$('<div id="_qr_container"><p class="qr_title"></p><div class="qr_img"></div><p class="qr_url"></p>'),t.appendTo(document.body)),t.find(".qr_title").html(a);new QRCode(t.find(".qr_img").empty()[0],{text:e,width:300,height:300,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H});layer.open({type:1,title:"",closeBtn:0,area:"400px",skin:"layui-layer-nobg",shadeClose:!0,content:t})},viewCodeMa:function(){var e=this;$(document).on("click",".img-link-look",function(){var a=$(this).siblings("a").attr("href"),t=$(this).parents("td").prev("td").text(),n="渠道名称：<strong style='font-size:1.1em;color:green'>"+t+"</strong>";e.generateCodeMa(a,n)})},initTime:function(){var e=this,a=$("#qidlistDate");a.attr("date-value",[moment().format("YYYYMMDD"),moment().format("YYYYMMDD")]);var t={maxDate:moment(),dateLimit:{days:30},showDropdowns:!1,showWeekNumbers:!1,timePicker:!1,timePickerIncrement:60,timePicker12Hour:!1,ranges:{"所有":[moment("20160101","YYYYMMDD"),moment()],"今日":[moment().startOf("day"),moment()],"昨日":[moment().subtract("days",1).startOf("day"),moment().subtract("days",1).endOf("day")],"最近7日":[moment().subtract("days",6),moment()],"最近30日":[moment().subtract("days",29),moment()]},opens:"left",buttonClasses:["btn btn-default"],applyClass:"btn-small btn-primary blue",cancelClass:"btn-small",format:"YYYY/MM/DD",separator:" to ",locale:{applyLabel:"确定",cancelLabel:"取消",fromLabel:"起始时间",toLabel:"结束时间",customRangeLabel:"自定义",daysOfWeek:["日","一","二","三","四","五","六"],monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],firstDay:1}},n=n||"今日";a.html(n),a.daterangepicker(t,function(t,n,o){var o="自定义"==o?t.format("YYYY/MM/DD")+" - "+n.format("YYYY/MM/DD"):o;a.html(o);var s=[t.format("YYYYMMDD"),n.format("YYYYMMDD")];a.attr("date-value",s);var i=(a.parents("time").siblings("overlay-btn").attr("data-value"),"all");a.parents(".title").find(".data_profile li").each(function(e,a){$(a).hasClass("active")&&(i=$(a).attr("data-value"))});var r=0;a.parents(".title").siblings(".contentER, .btnBox").find('[data-name="type"]').each(function(e,a){$(a).hasClass("active")&&(r=$(a).attr("data-value"))}),e.valuePicker()})},renderList:function(e,a,t,n,o){var s=this,i=moment().format("YYYYMMDD"),r=moment().format("YYYYMMDD");e&&(i=e.split(",")[0],r=e.split(",")[1]),$("#_loading_mask").show(),$.ajax({url:"http://api.shareinstall.com/channel/getlist",type:"POST",data:{username:$.cookie("userName"),token:$.cookie("_token"),app_key:$.cookie("appkey"),page:s.page||1,size:10,startDate:i,endDate:r,plantform:a||"all",exclude:0,sortname:t||"createTime",sorttype:n||"desc",search:{channel_name:o||""}},success:function(e){if(0==e.code){$("#_loading_mask").hide(),e.data instanceof Array==!0||1!==s.page||o||(e.data=[]),$.each(e.data,function(e,a){a.createTime=s.timetrans(a.createTime),"1"===a.page_type?a.page=window.location.href.replace("management.html","")+"demo.html?appkey="+$.cookie("appkey")+"&channel="+a.channel_code:"2"===a.page_type&&(a.page=a.page+"?channel="+a.channel_code)}),10===e.data.length&&(e.pageNext=s.page+1),e.pageCur=s.page,e.pagePre=s.page-1;var a=Handlebars.compile(s.tpl),i=a(e);$("#channelContainer").html(i);$(".channel-th th[data-field]").each(function(e,a){$(a).find(">span").removeClass("sort-none sort-asc sort-desc").addClass("sort-none"),$(a).attr("data-field")===t&&$(a).find(">span").removeClass("sort-none sort-asc sort-desc").addClass("sort-"+n)})}else"88"===e.code&&(layer.msg("登录失效，请重新登录"),setTimeout(function(){window.location.href="./login.html"},3e3))}})},removeChannel:function(){var e=this;$("body").on("click",".img-link-lock",function(){var a=$(this).attr("data-id");layer.confirm("渠道被删除后，分发出去的渠道链接将失效，确定要删除吗？",{btn:["确定删除","取消"]},function(){e.requestRemove(a)})})},requestRemove:function(e){var a=this;$.ajax({url:"http://api.shareinstall.com/channel/delete",type:"POST",data:{username:$.cookie("userName"),token:$.cookie("_token"),app_key:$.cookie("appkey"),channel_id:e},success:function(e){0===parseInt(e.code)?(a.renderList(),layer.msg("删除成功")):layer.msg(e.message)},error:function(){layer.msg("删除失败")}})},selectPage:function(){var e=this;$("body").on("click",".page-change",function(){e.page=$(this).attr("data-page"),e.valuePicker()}),$("body").on("click",".page-change-start",function(){e.page-=1,e.renderList()}),$("body").on("click",".page-change-end",function(){e.page+=1,e.valuePicker()})},valuePicker:function(){var e=$("#search_form input").val(),a=$(".data_profile").find(".active").attr("data-value"),t=$("#qidlistDate").attr("date-value"),n=$(".channel-th th[data-field]"),o="",s="";n.each(function(e,a){$(a).find(">span").hasClass("sort-none")||(o=$(a).attr("data-field"),s=$(a).find(">span").attr("class").split("-")[1])}),this.renderList(t,a,o,s,e)},triggerEvent:function(){var e=this;$(".date-container").on("click",function(e){"date-value"!==e.target.className&&$(this).find(".date-value").click()}),$(".data_profile li").on("click",function(){$(this).addClass("active").siblings("li").removeClass("active"),e.page=1,e.valuePicker()}),$("#search_button").on("click",function(){e.word=$('input[name="search"]').val(),e.page=1,e.valuePicker()}),$(document).on("click",".channel-th th[data-field]",function(a){if("common-tip"===a.target.className)return!1;e.page=1;var t=$(this).find(">span");t.hasClass("sort-none")?(t.removeClass("sort-none").addClass("sort-desc"),$(this).siblings("th[data-field]").find(">span").removeClass("sort-asc sort-desc").addClass("sort-none")):t.hasClass("sort-desc")?t.removeClass("sort-desc").addClass("sort-asc"):t.hasClass("sort-asc")&&t.removeClass("sort-asc").addClass("sort-desc"),e.valuePicker()})},handlebarHelp:function(){Handlebars.registerHelper("pager",function(e,a){var t=e.data.root,n="<ul class='pagination'>";return t.pagePre>0?n+='<li><a href="javascript:;" class="page-change-start">上一页</a></li>':n+="<li><a disabled='disabled' href='javascript:;' class='disabled_pre'>上一页</a></li>",t.pageNext?n+='<li><a class="page-change-end" href="javascript:;">下一页</a></li>':n+="<li><a disabled='disabled' href='javascript:;' class='disabled_pre'>下一页</a></li>",n+="</ul>"}),Handlebars.registerHelper("more",function(e){return!!(e.next>e.max)})}};return e[a.name]=a,e}(DfttModule||{});$(function(){$.each(DfttModule,function(e,a){$.isPlainObject(a)?$.isFunction(a.init)||console.error(a.init+" is not a Function!"):console.error(a+" is not a PlainObject!")})});