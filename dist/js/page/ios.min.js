var DfttModule=function(dm){var Index={name:"Index",hasBag:!1,init:function(){var e=this;e.handlebarsHelp(),e.getAppInfo(),e.tabsFun(),e.writeAppkey(),e.drawAppicon(),e.writeAppName(),e.writeScheme(),e.uploadPackage(),e.getPackageInfo(),e.configApp(),e.nextFun(),e.prevFun(),e.onlineTest()},writeAppkey:function(){var e=$.cookie("appkey");e&&($("#app_key").text(e),$("#configAppKey").text(e),$(".doc-link").text(e.toLowerCase()),$(".doc-appkey").text(e))},drawAppicon:function(){var e=$.cookie("img");e&&$("#app_icon").attr("src",e)},writeAppName:function(){var e=$.cookie("appName");e&&$("#app_name").text(e)},writeScheme:function(){var e=$.cookie("scheme");e&&($("#configScheme").text(e),$(".doc-scheme").text(e))},normalizeUrl:function(e,t){if(!e||!(e=$.trim(e)))return null;var n=!0===t?/^([0-9a-zA-Z_\-]+):\/\/[^\/]+(\/.*)?/i:/^(http|https):\/\/[^\/]+(\/.*)?/i,a=n.exec(e);return a?(a[2]||(e+="/"),e):null},getLength:function(e){return e.replace(/[\u0391-\uFFE5]/g,"aa").length},inputLimit:function(){var e=this,t=0;$('input[name="key"], input[name="value"]').on("input propertychange",function(){var n=$(this).val();if(e.getLength(n)<=20&&(t=n.length),e.getLength(n)>20)return $(this).val($(this).val().substr(0,t)),!1})},getAppInfo:function(){var e=this;$.ajax({url:Tool.serverIP()+"appliance/getone",data:{app_key:$.cookie("appkey")},type:"POST",success:function(t){var n=t.data.app_over_time.replace(/-/g,"/"),a=parseInt(new Date(n)-new Date)/1e3/60/60/24;t.code=parseInt(t.code),0===t.code&&(0==t.data.status?e.pageInit():a<=10&&2==t.data.status&&e.pageInit(a))}})},pageInit:function(e){var t=$("#paymentInfo"),n=0;e&&(t.find(".pop-status").text("还有"+Math.round(e)+"天服务将过期"),n=1),n&&!$.cookie("warnshow"+$.cookie("appkey"))?($.cookie("warnshow"+$.cookie("appkey"),1,{expires:1}),layer.open({title:"到期提醒",type:1,area:"800",content:t,closeBtn:n})):n||layer.open({title:"到期提醒",type:1,area:"800",content:t,closeBtn:n})},onlineTest:function(){this.inputLimit(),$(document).on("click",".depoly-line-test",function(){var e=$("#_win_web_test");e.find(".qr_img").empty(),e.find(".qr_text").text(""),layer.open({title:" ",type:1,area:"800",content:e})}),$(document).on("click",".depoly-button",function(){var e=$('input[name="key"]').val(),t=$('input[name="value"]').val(),n=window.location.href.replace("ios.html","")+"js-test.html?appkey="+$.cookie("appkey")+"&"+e+"="+t,a=!0;if(/[\u4e00-\u9fa5]+/.test(e)&&(a=!1,layer.tips("输入不能包含中文",$('input[name="key"]'),{tipsMore:!0,tips:[2,"#ff3333"]})),/[\u4e00-\u9fa5]+/.test(t)&&(a=!1,layer.tips("输入不能包含中文",$('input[name="value"]'),{tipsMore:!0,tips:[2,"#ff3333"]})),a){new QRCode($(".qr_img").empty()[0],{text:n,width:180,height:180,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H})}console.log(n)})},tabsFun:function(){$(".tab-form li").on("click",function(){$(this).addClass("active").siblings().removeClass("active");var e=$(this).index();$(".my-app").eq(e).show().siblings().hide(),$(document).scrollTop(0)})},prevFun:function(){$(".step_prev").on("click",function(){var e=parseInt($(this).attr("data-tab-index"));$("#tabs li").eq(e).addClass("active").siblings().removeClass("active"),$(".my-app").eq(e).show().siblings().hide(),$(document).scrollTop(0)})},nextFun:function(){$(".step_next").on("click",function(){var e=parseInt($(this).attr("data-tab-index"));$("#tabs li").eq(e).addClass("active").siblings().removeClass("active"),$(".my-app").eq(e).show().siblings().hide(),$(document).scrollTop(0)})},uploadPackage:function(){function upfile(e){start=0,end=LENGTH+start,blob_num=1,(file=e||document.getElementsByName("mof")[0].files[0])&&up()}function up(){if(!pending){var total_blob_num=Math.ceil(file.size/LENGTH);start<file.size&&(xhr.open("POST",Tool.serverIP()+"passage/upload2",!0),xhr.onreadystatechange=function(){4==this.readyState&&(this.status>=200&&this.status<300?(console.log(this.responseText),console.log(this.responseText.code),tmp=this.responseText,resp=eval("("+tmp+")"),console.log(typeof resp),console.log(resp.code),resp.code<0?(layer.msg("文件发送失败，请重新发送"),des.style.width="0%"):(start=end,end=start+LENGTH,blob_num==total_blob_num&&(timer=setTimeout(function(){$.ajax({async:!1,type:"POST",url:Tool.serverIP()+"passage/check2",data:{app_key:appKey},success:function(e){if("0"===e.code){file.value="",_this.hasBag=!0;var t=new Date(1e3*e.data.createTime);e.data.createTime=t.getFullYear()+"/"+(t.getMonth()+1>9?t.getMonth()+1:"0"+(t.getMonth()+1))+"/"+(t.getDate()>9?t.getDate():"0"+t.getDate())+" "+(t.getHours()<10?"0"+t.getHours():t.getHours())+":"+(t.getMinutes()<10?"0"+t.getMinutes():t.getMinutes())+":"+(t.getSeconds()<10?"0"+t.getSeconds():t.getSeconds());var n=$(".pkgInfoTmp").html(),a=Handlebars.compile(n),o=a(e.data);$(".pkgInfoContainer").html(o),$("#configAppBundle").html(e.data.bundle_id),$("#configAppTeam").html(e.data.team_id),$("#configScheme").html(e.data.scheme),$('input[name="appstoreUrl"]').val(""),$('input[name="yybEnabled"]').prop("checked",!1),$('input[name="yybUrl"]').prop("disabled",!0).val(""),$("#load").css("width","0%"),$("#loadProcess").text("0%"),$("#upimg").css("display","none"),$(".upload-filebtn").val(""),$(".btn-upload-back").click(),$(".depoly-line-test").show(),$(".up_progress").hide(),$(".up_container").show(),$(".depoly-top").hide(),layer.confirm('上传成功,请至“ios应用配置"选项卡填写应用appstore地址”',{btn:["确定"]},function(e){layer.close(e),$(".tab-form li").eq(2).click(),$('input[name="appstoreUrl"]').focus()})}else"88"===e.code?(layer.msg("登录失效，请重新登录"),setTimeout(function(){window.location.href="./login.html"},3e3)):(file.value="",$(".upload-filebtn").val(""),layer.msg(e.message||"文件解析失败"),$(".up_progress").hide(),$(".up_container").show())}})},2e3)),blob_num+=1,setTimeout(function(){up()},1e3))):($(".upload-filebtn").val(""),layer.msg("已取消文件上传"),des.style.width="0%"))},xhr.upload.onprogress=function(e){e.lengthComputable&&(pecent=100*(e.loaded+start)/file.size,pecent>100&&(pecent=100),des.style.width=pecent+"%",desProcess.innerHTML=parseInt(pecent)+"%",$(".up_progress .prog_uploaded").text(((e.loaded+start)/1024/1024).toFixed(2)+"MB"))},blob=file.slice(start,end),fd=new FormData,fd.append("mof",blob),fd.append("filename",file.name),fd.append("blob_num",blob_num),fd.append("total_blob_num",total_blob_num),fd.append("app_key",appKey),xhr.send(fd))}}function change(){des.style.width="0%"}var _this=this;$(".btn-to-upload").on("click",function(){$(".deposite_upload").show(),$(".btn-to-upload").hide(),$(".pkgInfoContainer").hide()}),$(".btn-upload-back").on("click",function(){$(".deposite_upload").hide(),$(".btn-to-upload").show(),$(".pkgInfoContainer").show()}),$(".upload-filebtn").on("change",function(){var e=$(".upload-filebtn")[0].files[0].name;/.ipa$/.test(e)?($("#upimg").show(),$(".up_progress").show(),$(".up_container").hide(),$(".up_progress .filename").text(e),pending=0,upfile()):layer.msg("请上传.ipa文件")}),$(".stop_upload").off("click").on("click",function(){xhr.abort(),pending=1,clearTimeout(timer),$(".up_progress").hide(),$(".up_container").show()});var dropbox=document.getElementsByClassName("up_area")[0];dropbox.addEventListener("dragenter",function(e){e.stopPropagation(),e.preventDefault()},!1),dropbox.addEventListener("dragover",function(e){e.stopPropagation(),e.preventDefault(),this.style.border="dashed 1px red"},!1),dropbox.addEventListener("drop",function(e){e.stopPropagation(),e.preventDefault(),this.style.border="0";var t=e.dataTransfer,n=t.files,a=n[0].name;/.ipa$/.test(a)?(pending=0,$("#upimg").show(),$(".up_progress").show(),$(".up_container").hide(),$(".up_progress .filename").text(a),upfile(n[0])):layer.msg("请上传.ipa文件")},!1);var xhr=new XMLHttpRequest,fd,des=document.getElementById("load"),desProcess=document.getElementById("loadProcess"),num=document.getElementById("upimg"),file;const LENGTH=5242880;var start,end,blob,pecent,filename,appKey=$.cookie("appkey"),timer=null,pending=0},setIosInfo:function(e,t,n){var a={};a.app_store=e||"",a.is_applied=t,a.applied_path=n||"",$.ajax({url:Tool.serverIP()+"passage/setinfo",type:"POST",data:{username:$.cookie("userName"),token:$.cookie("_token"),app_key:$.cookie("appkey"),plantform:"ios",para:a},success:function(e){"0"===e.code?layer.msg("信息保存成功"):"88"===e.code?(layer.msg("登录失效，请重新登录"),setTimeout(function(){window.location.href="./login.html"},3e3)):layer.msg(e.message)}})},getPackageInfo:function(){var e=this,t=$.cookie("appkey");$.ajax({url:Tool.serverIP()+"passage/info",type:"POST",data:{username:$.cookie("userName"),token:$.cookie("_token"),app_key:t,plantform:"ios"},success:function(t){if("0"===t.code){e.hasBag=!0;var n=new Date(1e3*t.data.createTime);t.data.createTime=n.getFullYear()+"/"+(n.getMonth()+1>9?n.getMonth()+1:"0"+(n.getMonth()+1))+"/"+(n.getDate()>9?n.getDate():"0"+n.getDate())+" "+(n.getHours()<10?"0"+n.getHours():n.getHours())+":"+(n.getMinutes()<10?"0"+n.getMinutes():n.getMinutes())+":"+(n.getSeconds()<10?"0"+n.getSeconds():n.getSeconds());var a=$(".pkgInfoTmp").html(),o=Handlebars.compile(a),i=o(t.data);$(".pkgInfoContainer").html(i),$("#configAppBundle").html(t.data.bundle_id),$("#configAppTeam").html(t.data.team_id),$("#configScheme").html(t.data.scheme),$('input[name="appstoreUrl"]').val(t.data.app_store),$('input[name="yybEnabled"]').prop("checked",!!t.data.is_applied),$('input[name="yybUrl"]').prop("disabled",!t.data.is_applied).val(t.data.applied_path),$(".depoly-line-test").show(),$(".depoly-top").hide()}else"88"===t.code&&(layer.msg("登录失效，请重新登录"),setTimeout(function(){window.location.href="./login.html"},3e3))}})},handlebarsHelp:function(){function _evalWithContext(context,__eval){return eval("with(context){"+__eval+"}")}Handlebars.registerHelper("eval",function(e,t){var n=e.fn(t);return _evalWithContext(e.data.root,n)}),Handlebars.registerHelper("if_even",function(e,t){return e%2==0?t.fn(this):t.inverse(this)}),Handlebars.registerHelper("loop",function(e,t){var n,a=t.hash.max;t.data&&(n=Handlebars.createFrame(t.data));for(var o=[],i=0;i<a;i++)n.index=i+1,o.push(t.fn(e[i],{data:n}));return o.join("")})},configApp:function(){var e=this;$('input[name="yybEnabled"]').on("change",function(){$(this).prop("checked")?$('input[name="yybUrl"]').prop("disabled",!1):$('input[name="yybUrl"]').prop("disabled",!0)}),$("#saveForm").on("click",function(){var t=$('input[name="appstoreUrl"]').val(),n=$('input[name="yybEnabled"]').prop("checked")?1:0,a=$('input[name="yybUrl"]').val();return e.hasBag?n&&!e.normalizeUrl(a)?void layer.tips("请正确填写应用宝地址",$('input[name="yybUrl"]'),{tipsMore:!0,tips:[2,"#ff3333"]}):void e.setIosInfo(t,n,a):void layer.msg("请先上传包")})}};return dm[Index.name]=Index,dm}(DfttModule||{});