function DatePicker(e,a,t){e=$(e),t=t||"所有";var n,s,r=moment("20160101","YYYYMMDD"),i=moment(),c={"所有":[r,i],"今天":[moment(),moment()],"昨天":[moment().subtract(1,"days"),moment().subtract(1,"days")],"最近七天":[moment().subtract(6,"days"),moment()],"最近30天":[moment().subtract(29,"days"),moment()]},l=function(a,t,r){n=a,s=t,e.find(".date-value").html("自由选取"==r?n.format("YYYY/MM/DD")+" - "+s.format("YYYY/MM/DD"):r)};e.daterangepicker({opens:"left",ranges:c,startDate:c[t][0],endDate:c[t][1]},function(e,t,n){l(e,t,n),a()}),l(c[t][0],c[t][1],t),this.getRange=function(){var e=n.format("YYYY/MM/DD"),a=s.format("YYYY/MM/DD"),t=e==r.format("YYYY/MM/DD")&&a==i.format("YYYY/MM/DD");return[t?null:e,t?null:a]}}function ValuePicker(e,a){e=$(e);var t={},n={};e.find("[data-name]").each(function(e,a){var a=$(a),s=a.attr("data-name");(t[s]||(t[s]=[])).push(a),a.is(".active")&&(n[s]=a.attr("data-value"))}).click(function(){var e=$(this),s=e.attr("data-name"),r=e.attr("data-value");if(1==t[s].length)e.toggleClass("active"),n[s]=e.is(".active")?r:null;else{if(e.is("active"))return;n[s]=r;for(var i=0;i<t[s].length;i++)t[s][i].removeClass("active");e.addClass("active")}a()}),this.getValues=function(){return $.extend({},n)}}function nextPage(e){e.pageNumber++,refreshPage(e)}function prevPage(e){e.pageNumber--,refreshPage(e)}function refreshPage(){showLoading();var e=$("#search_form").find("input[name='search']").val(),a=datePicker.getRange(),t=$.extend({page:request.pageNumber,appId:params.appId,startTime:a[0],endTime:a[1],sortField:request.sortField,asc:request.asc,pageSize:10,search:e},valuePicker.getValues());ajaxGet("channel/stats/list",t,function(a){request.pageNumber=a.pageNum,request.channels={};for(var n=0,s=a.rows.length;n<s;n++)a.rows[n].sCreateTime=a.rows[n].createTime?formatDate(a.rows[n].createTime):"",request.channels[a.rows[n].id]=a.rows[n];a.search=e,a.pageSize=10,$("#channelContainer").html(compiler(a)).find("thead th[data-field] span").each(function(e,a){(a=$(a)).parent().attr("data-field")==request.sortField?a.addClass(request.asc?"sort-asc":"sort-desc").removeClass(request.asc?"sort-desc":"sort-asc"):a.removeClass("sort-asc sort-desc").addClass("sort-none")}),$("#stats_export").attr("href","/cgi/channel/export?"+serializeToString(t)),hideLoading()},function(e){hideLoading(),layer.msg("查询失败"+(e.msg?"："+e.msg:""))})}function removeChannel(e){layer.confirm("渠道被删除后，分发出去的渠道链接将失效，确定要删除吗？",{btn:["确定删除","取消"]},function(){ajaxPost("/channel/delete",{channelId:e,appId:params.appId},function(){refreshPage(request),layer.msg("删除成功")})})}function showApkExport(e){ajaxGet("channel/apk-export-url",{appId:params.appId,channelId:e},function(e){$("#win_apk_url").text(e.url).attr("href",e.url)}),layer.open({title:"导出android渠道包",type:1,area:"600",content:$("#win_apk_export")})}function selectPage(e,a){e.pageNumber=a,refreshPage(e)}function back(){window.location="channel-list.html"}function checkboxChanged(){$("#zi_url")["false"==$(":checked[name='defaultLanding']").val()?"show":"hide"]()}var valuePicker=new ValuePicker("#stats_bar",refreshPage),datePicker=new DatePicker("#stats_bar .time",refreshPage),request={pageNumber:0,sortField:"createTime",asc:!1},compiler=Handlebars.compile($("#channelTmp").html());$("#channelContainer").delegate("thead th[data-field]","click",function(e){$(e.target).is(".common-tip")||(request.sortField=$(this).attr("data-field"),request.asc=$(this).find("span").hasClass("sort-desc"),refreshPage(request))}),refreshPage(request),$("#search_form").submit(function(){return request.pageNumber=0,refreshPage(),!1}),$("#search_button").click(function(){request.pageNumber=0,refreshPage()}),Handlebars.registerHelper("list",function(e,a){var t="<ul class='pagination'>";if(e.hasPrev?t+='<li><a  onclick="prevPage(request)" href="javascript:;">&lt;</a></li>':t+="<li><a disabled='disabled' href='javascript:;' class='disabled_pre'>&lt;</a></li>",e.pageNum<3)for(var n=0;n<e.pageNum;n++)t=t+"<li><a href='javascript:;' onclick='selectPage(request, "+n+")'>"+(n+1)+"</a></li>";else t=t+"<li><a href='javascript:;' onclick='selectPage(request, "+(e.pageNum-2)+")'>"+(e.pageNum-1)+"</a></li>",t=t+"<li><a href='javascript:;' onclick='selectPage(request, "+(e.pageNum-1)+")'>"+e.pageNum+"</a></li>";if(t=t+"<li class=\"active\"><a href='javascript:;'>"+(e.pageNum+1)+"</a></li>",e.pages-e.pageNum<=3)for(var n=e.pageNum+1;n<e.pages;n++)t=t+"<li><a href='javascript:;' onclick='selectPage(request, "+n+")'>"+(n+1)+"</a></li>";else t=t+"<li><a href='javascript:;' onclick='selectPage(request, "+(e.pageNum+1)+")'>"+(e.pageNum+2)+"</a></li>",t=t+"<li><a href='javascript:;' onclick='selectPage(request, "+(e.pageNum+2)+")'>"+(e.pageNum+3)+"</a></li>";return e.hasNext?t+='<li><a onclick="nextPage(request)" href="javascript:;">&gt;</a></li>':t+="<li><a disabled='disabled' href='javascript:;' class='disabled_pre'>&gt;</a></li>",t+"</ul>"});var shareChannel=function(){var e,a;return $("#share_password_change").click(function(){$("#share_password").prop("disabled",!1),$("#share_password_change").hide(),$("#share_password_submit").show()}),$("#share_password_submit").click(function(){var e=$("#share_password").val();e.length>6?layer.tips("分享密码不能超过6位",$("#share_password"),{tipsMore:!0,tips:[2,"#ff3333"]}):ajaxPost("/channel/change-share-password",{appId:params.appId,channelId:a,sharePassword:e},function(){layer.msg("修改成功",{time:1e3},function(){$("#share_password").prop("disabled",!0),$("#share_password_change").show(),$("#share_password_submit").hide()})})}),function(t){a=t,ajaxGet("/channel/get",{channelId:a,appId:params.appId},function(a){$("#share_channelCode").text(a.channelCode),$("#share_channelName").text(a.channelName),$("#share_url").text(a.shareUrl).attr("href",a.shareUrl),$("#share_password").val(a.sharePassword),e=layer.open({title:["渠道数据分享","font-size:18px;padding-left: 261px;"],type:1,area:"630",content:$("#share_channel")}),$("#share_password").prop("disabled",!0),$("#share_password_change").show(),$("#share_password_submit").hide()})}}();getAppInfo(function(e){$("#_code_appKey").text('"'+e.appKey+'"')}),ajaxGet("/appinfo/banner",{appId:params.appId},function(e){$("#app_tmp2").text(e.banner.scriptTag)});var channelId=params.channelId;channelId?($("#_title").text("修改渠道"),ajaxGet("/channel/get",{channelId:channelId,appId:params.appId},function(e){if(e){var a=$("#channel_form");a.find(":input[name='channelCode']").val(e.channelCode).prop("disabled",!0).css({backgroundColor:"#ededed"}),a.find(":input[name='channelName']").val(e.channelName),a.find(":input[name='customURL']").val(e.customURL),a.find(":input[name='defaultLanding']").each(function(a,t){$(t).prop("checked","true"==$(t).val()==e.defaultLanding)}),checkboxChanged()}})):$("#_title").text("渠道管理-新增渠道"),$("#cancel_btn").click(back),$("#channel_form").submit(function(){var e=$(this),a=serializeObject(e),t=!1;return a.channelCode||e.find("input[name='channelCode']").prop("disabled")||(t=!0,layer.tips("必填",e.find("input[name='channelCode']"),{tipsMore:!0,tips:[2,"#ff3333"]})),a.channelName||(t=!0,layer.tips("必填",e.find("input[name='channelName']"),{tipsMore:!0,tips:[2,"#ff3333"]})),"false"!=a.defaultLanding||(a.customURL=normalizeUrl(a.customURL))||(t=!0,layer.tips("请填写合法的url，如：http://www.opeinstall.io/",e.find("input[name='customURL']"),{tipsMore:!0,tips:[2,"#ff3333"]})),t||(a.channelId=channelId,a.appId=params.appId,ajaxPost(channelId?"/channel/update":"/channel/add",$.param(a),function(){back()})),!1}),$("#submit_btn").click(function(){$("#channel_form").submit()}),$("input[name='defaultLanding']").change(checkboxChanged),$("#app_banner").click(function(){$("#app_banner").addClass("app_jicheng"),$("#app_tmp1").css("display","none"),$("#app_tmp2").css("display","block"),$("#app_jicheng").removeClass("app_jicheng")}),$("#app_jicheng").click(function(){$("#app_jicheng").addClass("app_jicheng"),$("#app_tmp2").css("display","none"),$("#app_banner").removeClass("app_jicheng"),$("#app_tmp1").css("display","block")}),getAppInfo(function(e){$(".config_appKey").text('"'+e.appKey+'"')});